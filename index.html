<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Pump Readings (MVP)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; margin:20px; }
    .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:12px; }
    button { padding:8px 12px; cursor:pointer; }
    table { border-collapse: collapse; width:100%; }
    th, td { border:1px solid #ddd; padding:8px; }
    th { background:#f7f7f7; text-align:left; }
    .pill { padding:2px 8px; border-radius:12px; display:inline-block; }
    .green { background:#e6f7ec; color:#156d2f; }
    .red   { background:#fde8e8; color:#9b1c1c; }
    .muted { color:#666; }
    .panel { border:1px solid #eee; border-radius:10px; padding:12px; margin-bottom:16px; box-shadow:0 1px 2px rgba(0,0,0,0.04); }
    .kv { display:grid; grid-template-columns: 160px 1fr; gap:6px 10px; align-items:center; }
    .mono { font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace; }
    .small { font-size:12px; }
    #events { white-space:pre-wrap; max-height:160px; overflow:auto; border:1px solid #eee; border-radius:8px; padding:8px; background:#fafafa; }
    #schema { word-break: break-all; }
  </style>
</head>
<body>
  <div id="auth" style="margin-bottom:16px; display:none;">
    <h2>Sign in</h2>
    <div class="row">
      <input id="email" type="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Password" />
      <button id="signin">Sign in</button>
    </div>
    <div id="authMsg" style="color:#b00;"></div>
  </div>

  <div id="app" style="display:none;">
    <h1>Pump Readings (MVP)</h1>

    <div class="row">
      <label>Time range:</label>
      <select id="range">
        <option value="6">Last 6 hours</option>
        <option value="24" selected>Last 24 hours</option>
        <option value="168">Last 7 days</option>
      </select>
      <button id="refresh">Refresh</button>
      <div id="status" class="muted"></div>
      <button id="signout" title="Sign out of this browser">Sign out</button>
    </div>

    <!-- Firmware panel -->
    <div class="panel">
      <h3 style="margin-top:0;">Firmware</h3>
      <div class="kv">
        <div class="muted">Current device FW</div>
        <div><span id="fwCurrent" class="mono">—</span></div>

        <div class="muted">Manifest FW</div>
        <div><span id="fwManifest" class="mono">—</span></div>

        <div class="muted">Update available</div>
        <div><span id="fwUpdateFlag" class="pill">—</span></div>
      </div>
      <div class="row" style="margin-top:10px;">
        <button id="fwCheckBtn">Check (compare)</button>
        <button id="fwForceBtn" title="Copies a mosquitto command to force a manifest check">Force device to check now</button>
        <span id="fwMsg" class="muted small"></span>
      </div>
      <div id="fwCmdWrap" class="small mono" style="display:none; margin-top:8px;">
        <div class="muted">Copied to clipboard:</div>
        <div id="fwCmdText"></div>
      </div>
    </div>

    <div class="row">
      <div>Latest: <span id="latest" class="pill"></span></div>
      <div>Total rows: <strong id="count">0</strong></div>
      <div>Signal: <span id="signal" class="pill"></span></div>
      <div>Last connected: <span id="lastconn">—</span></div>
      <div>Last seen: <span id="lastseen">—</span></div>
      <div>Wi-Fi: <span id="rssiNow">—</span></div>
      <div>Latest Temp A: <span id="tempALatest">—</span></div>
      <div>Latest Temp B: <span id="tempBLatest">—</span></div>
    </div>

    <canvas id="chartA" height="140"></canvas>
    <canvas id="chartB" height="140" style="margin-top:14px;"></canvas>

    <table style="margin-top:16px;">
      <thead>
        <tr>
          <th>Time (UTC)</th>
          <th>Device</th>
          <th>Status</th>
          <th>Temp A °C</th>
          <th>Temp B °C</th>
          <th>RSSI</th>
          <th>FW</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <div class="panel" style="margin-top:16px;">
      <h3 style="margin-top:0;">Events</h3>
      <div id="events" class="mono small"></div>
      <div id="schema" class="mono small muted" style="margin-top:6px;"></div>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // --- CONFIG ---
    const SUPABASE_URL = "https://ojomcciunusemwszdnrl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qb21jY2l1bnVzZW13c3pkbnJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3MTUyODYsImV4cCI6MjA3MDI5MTI4Nn0.U7gKI4QOklKkSq_Jbfxm6hQBrvS4JipV7z6KtIl1kz8";
    const MANIFEST_URL = "https://ojomcciunusemwszdnrl.supabase.co/storage/v1/object/public/ota/manifest.json";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const MQTT = {
      host: "3614c4f5a4b94a56a45e17893c67c2d7.s1.eu.hivemq.cloud",
      port: 8883,
      user: "aug25",
      pass: "f71pSt1cK",
      cafile: "C:\\certs\\cacert.pem",
      devId: "pump-1",
      topicCmd: (id) => `pump/uv/cmd/${id}`
    };

    // --- UI refs ---
    const els = Object.fromEntries([
      'auth','app','email','password','signin','authMsg','signout','range','refresh','status',
      'rows','latest','count','signal','lastconn','lastseen','rssiNow','tempALatest','tempBLatest',
      'fwCurrent','fwManifest','fwUpdateFlag','fwCheckBtn','fwForceBtn','fwMsg','fwCmdWrap','fwCmdText',
      'events','schema'
    ].map(id => [id, document.getElementById(id)]));

    function log(m){ els.events.textContent = `[${new Date().toLocaleTimeString()}] ${m}\n` + els.events.textContent; }

    // Safely parse raw JSON if present on a row
    function parseRaw(row){
      let o=null;
      try{
        if (typeof row.raw === 'string') o = JSON.parse(row.raw);
        else if (row.raw && typeof row.raw === 'object') o = row.raw;
      }catch(_){}
      return o;
    }

    // Augment rows with resolved fields from raw
    function augmentRows(rows){
      return rows.map(r=>{
        const o = parseRaw(r) || {};
        const a = { ...r };
        // resolved values
        a.$fw  = r.fw ?? o.fw ?? o.fw_version ?? null;
        a.$ta  = r.temp_pump_a_c ?? o.temp_pump_a_c ?? r.temp_a ?? o.temp_a ?? r.temp_c ?? o.temp_c ?? null;
        a.$tb  = r.temp_pump_b_c ?? o.temp_pump_b_c ?? r.temp_b ?? o.temp_b ?? null;
        a.$uv  = r.uv_status ?? o.uv_status ?? r.status ?? o.status ?? null;
        a.$rssi= r.rssi ?? o.rssi ?? r.wifi_rssi ?? o.wifi_rssi ?? null;
        a.$ts  = r.ts ?? r.inserted_at ?? o.ts ?? o.time ?? null;
        a.$dev = r.device_id ?? r.device ?? o.device_id ?? o.device ?? null;
        return a;
      });
    }

    // Column/debug line
    function describeDetection(rows){
      if (!rows.length){ els.schema.textContent='No rows found.'; return; }
      const keys = Object.keys(rows[0]).join(', ');
      const sample = rows[0];
      els.schema.textContent =
        `Resolved → ts:${sample.$ts?'✓':'—'}, fw:${sample.$fw?'✓':'—'}, A:${sample.$ta!=null?'✓':'—'}, B:${sample.$tb!=null?'✓':'—'}, rssi:${sample.$rssi!=null?'✓':'—'}, status:${sample.$uv?'✓':'—'}, device:${sample.$dev?'✓':'—'} | Raw keys: ${keys}`;
    }

    // charts
    let chartA, chartB;
    function renderCharts(rows){
      const ordered = rows.slice().reverse();
      const labels = ordered.map(r => new Date(r.$ts).toLocaleTimeString());
      const A = ordered.map(r => r.$ta==null?null:Number(r.$ta));
      const B = ordered.map(r => r.$tb==null?null:Number(r.$tb));

      const ctxA = document.getElementById('chartA').getContext('2d');
      const ctxB = document.getElementById('chartB').getContext('2d');
      const dsA = [{ data:A, spanGaps:true, pointRadius:0, borderWidth:2, label:'Temp A (°C)' }];
      const dsB = [{ data:B, spanGaps:true, pointRadius:0, borderWidth:2, label:'Temp B (°C)' }];
      const opts = { animation:false, plugins:{legend:{display:true}}, scales:{ y:{ title:{display:true,text:'°C'} } } };

      if (!chartA) chartA = new Chart(ctxA, { type:'line', data:{ labels, datasets:dsA }, options:opts });
      else { chartA.data.labels = labels; chartA.data.datasets[0].data = A; chartA.update('none'); }

      if (!chartB) chartB = new Chart(ctxB, { type:'line', data:{ labels, datasets:dsB }, options:opts });
      else { chartB.data.labels = labels; chartB.data.datasets[0].data = B; chartB.update('none'); }
    }

    function rssiLabel(dbm){ if (dbm>=-60) return 'Excellent'; if (dbm>=-67) return 'Very good'; if (dbm>=-75) return 'Good'; if (dbm>=-82) return 'Fair'; if (dbm>=-90) return 'Poor'; return 'Very poor'; }
    function isRecent(tsIso, sec){ if (!tsIso) return false; return (Date.now()-new Date(tsIso).getTime()) <= sec*1000; }

    async function load(){
      const { data: { session } } = await sb.auth.getSession();
      if (!session){ log('Not signed in.'); return; }

      const hours = parseInt(els.range.value,10);
      els.status.textContent = 'Loading…';
      log(`Load start (range=${hours}h)…`);

      const fromIso = new Date(Date.now() - hours*3600*1000).toISOString();
      let { data, error } = await sb.from('pump_readings').select('*').gte('ts', fromIso).order('ts', { ascending:false }).limit(500);
      if (error){ els.status.textContent = 'Error: ' + error.message; return; }

      // augment with values from raw JSON
      const rows = augmentRows(data);
      describeDetection(data);

      els.count.textContent = rows.length;

      // latest row UI
      if (rows.length){
        const latest = rows[0];

        // status / temps
        els.latest.textContent = latest.$uv || '—';
        els.latest.className = 'pill ' + ((latest.$uv==='GREEN') ? 'green' : 'red');
        els.tempALatest.textContent = (latest.$ta==null)?'—':(+latest.$ta).toFixed(2)+' °C';
        els.tempBLatest.textContent = (latest.$tb==null)?'—':(+latest.$tb).toFixed(2)+' °C';

        // current FW (from raw if needed)
        els.fwCurrent.textContent = latest.$fw || '—';

        // device_status (best effort)
        try{
          const did = latest.$dev;
          const { data: ds } = await sb.from('device_status').select('last_seen_ts,last_online_ts,online').eq('device_id', did).single();
          if (ds){
            els.lastconn.textContent = ds.last_online_ts ? new Date(ds.last_online_ts).toLocaleString() : (ds.online?'now':'—');
            els.lastseen.textContent = ds.last_seen_ts ? new Date(ds.last_seen_ts).toLocaleString() : (ds.online?'now':'—');
            const fresh = rows.filter(r => r.$rssi!=null && isRecent(r.$ts,120)).slice(0,5);
            if (fresh.length){
              const avg = fresh.reduce((s,r)=>s+Number(r.$rssi),0)/fresh.length;
              els.rssiNow.textContent = `${avg.toFixed(0)} dBm (${rssiLabel(avg)})`;
            } else els.rssiNow.textContent = 'No signal';
          }
        }catch(_){}
      } else {
        els.latest.textContent = '—'; els.latest.className='pill';
        els.fwCurrent.textContent = '—';
        els.rssiNow.textContent = '—';
      }

      // table
      els.rows.innerHTML = '';
      for (const r of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(r.$ts).toISOString()}</td>
          <td>${r.$dev ?? ''}</td>
          <td><span class="pill ${(r.$uv==='GREEN')?'green':'red'}">${r.$uv ?? ''}</span></td>
          <td>${r.$ta==null?'':Number(r.$ta).toFixed(2)}</td>
          <td>${r.$tb==null?'':Number(r.$tb).toFixed(2)}</td>
          <td>${r.$rssi ?? ''}</td>
          <td class="mono">${r.$fw ?? ''}</td>
        `;
        els.rows.appendChild(tr);
      }

      renderCharts(rows);

      // staleness badge
      if (rows.length){
        const ageMin = Math.floor((Date.now() - new Date(rows[0].$ts).getTime())/60000);
        const fresh = ageMin <= 10;
        els.signal.textContent = fresh ? 'OK' : `STALE: ${ageMin}m`;
        els.signal.className = 'pill ' + (fresh ? 'green' : 'red');
      } else {
        els.signal.textContent = 'NO DATA';
        els.signal.className = 'pill red';
      }

      els.status.textContent = 'Last updated: ' + new Date().toLocaleTimeString();
      log('Load done: rows=' + rows.length);
    }

    // manifest compare
    function cmpSemver(a,b){ const pa=String(a).split('.').map(n=>parseInt(n,10)); const pb=String(b).split('.').map(n=>parseInt(n,10)); for(let i=0;i<3;i++){const x=pa[i]||0,y=pb[i]||0;if(x!==y)return x<y?-1:1;} return 0; }
    async function fetchManifest(){ const url = MANIFEST_URL + '?cb=' + Date.now(); const res = await fetch(url,{cache:'no-store'}); if(!res.ok) throw new Error('manifest fetch '+res.status); return res.json(); }
    async function refreshFirmwareCompare(){
      els.fwMsg.textContent='Fetching manifest…'; els.fwCmdWrap.style.display='none';
      try{
        const m = await fetchManifest();
        const mver = m.version || '—';
        els.fwManifest.textContent = mver;

        const cur = (els.fwCurrent.textContent||'').trim();
        if (!cur || cur==='—' || !mver || mver==='—'){
          els.fwUpdateFlag.textContent='—'; els.fwUpdateFlag.className='pill';
          els.fwMsg.textContent = cur && cur!=='—' ? 'Manifest loaded.' : 'Manifest loaded; waiting for device FW…';
          log('Manifest fetched, current FW ' + (cur && cur!=='—' ? cur : 'unknown') + '.');
          return;
        }
        const newer = cmpSemver(cur, mver) < 0;
        els.fwUpdateFlag.textContent = newer ? 'YES' : 'No';
        els.fwUpdateFlag.className = 'pill ' + (newer ? 'red' : 'green');
        els.fwMsg.textContent = newer ? 'New firmware available in manifest.' : 'Device is up to date.';
        log(`Manifest compare: current=${cur}, manifest=${mver}, update=${newer?'YES':'No'}`);
      }catch(e){
        els.fwManifest.textContent='—'; els.fwUpdateFlag.textContent='—'; els.fwUpdateFlag.className='pill';
        els.fwMsg.textContent='Manifest fetch failed.'; log('Manifest fetch failed: '+e.message);
      }
    }

    // force-check command
    function buildForceCheckCommand(){
      const topic = MQTT.topicCmd(MQTT.devId);
      return `"C:\\Program Files\\mosquitto\\mosquitto_pub.exe" -h ${MQTT.host} -p ${MQTT.port} -V mqttv311 --cafile "${MQTT.cafile}" -u ${MQTT.user} -P ${MQTT.pass} -t "${topic}" -m "{\\"cmd\\":\\"check_update\\"}"`;
    }
    async function copyForceCheck(){
      const cmd = buildForceCheckCommand();
      try{ await navigator.clipboard.writeText(cmd); }catch(_){}
      els.fwCmdText.textContent = cmd;
      els.fwCmdWrap.style.display = 'block';
      els.fwMsg.textContent = 'Command copied. Paste into Command Prompt.';
      log('Force-check command copied.');
    }

    // auth + UI
    async function refreshAuthUI(){
      const { data: { session } } = await sb.auth.getSession();
      const authed = !!session;
      document.getElementById('auth').style.display = authed ? 'none' : 'block';
      document.getElementById('app').style.display  = authed ? 'block' : 'none';
      if (authed){ await load(); await refreshFirmwareCompare(); }
    }
    document.getElementById('refresh').addEventListener('click', async ()=>{ await load(); await refreshFirmwareCompare(); });
    document.getElementById('range').addEventListener('change', async ()=>{ await load(); await refreshFirmwareCompare(); });
    document.getElementById('fwCheckBtn').addEventListener('click', refreshFirmwareCompare);
    document.getElementById('fwForceBtn').addEventListener('click', copyForceCheck);
    document.getElementById('signin').addEventListener('click', async ()=>{
      document.getElementById('authMsg').textContent = '';
      const { error } = await sb.auth.signInWithPassword({ email: document.getElementById('email').value.trim(), password: document.getElementById('password').value });
      if (error){ document.getElementById('authMsg').textContent = error.message; return; }
      await refreshAuthUI();
    });
    document.getElementById('signout').addEventListener('click', async ()=>{ await sb.auth.signOut(); await refreshAuthUI(); });

    // start + periodic refresh
    refreshAuthUI();
    setInterval(async ()=>{ await load(); await refreshFirmwareCompare(); }, 10000);
  </script>
</body>
</html>
