<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Pump Readings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --fg:#111; --muted:#666; --line:#e9e9e9; --bg:#fff; }
    body { font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; color:var(--fg); background:var(--bg); margin:20px; }
    h1 { margin:0 0 10px; font-size:20px; }
    .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:12px; }
    .panel { border:1px solid #eee; border-radius:10px; padding:12px; margin:14px 0; box-shadow:0 1px 2px rgba(0,0,0,0.04); }
    .kv { display:grid; grid-template-columns: 160px 1fr; gap:6px 10px; align-items:center; }
    .pill { padding:2px 8px; border-radius:12px; display:inline-block; border:1px solid var(--line); }
    .green { background:#e6f7ec; color:#156d2f; }
    .red   { background:#fde8e8; color:#9b1c1c; }
    .muted { color:var(--muted); }
    .small { font-size:12px; }
    .mono { font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace; }
    button, input, select { padding:8px 10px; border:1px solid var(--line); border-radius:8px; background:#fff; }
    button { cursor:pointer; }
    table { border-collapse: collapse; width:100%; }
    th, td { border:1px solid #ddd; padding:8px; }
    th { background:#f7f7f7; text-align:left; }
    #events { white-space:pre-wrap; max-height:160px; overflow:auto; border:1px solid #eee; border-radius:8px; padding:8px; background:#fafafa; }
    #schema { word-break: break-all; }
  </style>
</head>
<body>
  <div id="auth" style="margin-bottom:16px; display:none;">
    <h2>Sign in</h2>
    <div class="row">
      <input id="email" type="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Password" />
      <button id="signin">Sign in</button>
    </div>
    <div id="authMsg" style="color:#b00;"></div>
  </div>

  <div id="app" style="display:none;">
    <h1>Pump Readings</h1>

    <div class="row">
      <label for="range">Time range:</label>
      <select id="range">
        <option value="24h" selected>Last 24 hours</option>
        <option value="7d">Last 1 week</option>
        <option value="30d">Last 30 days</option>
        <option value="90d">Last 90 days</option>
      </select>
      <button id="refresh">Refresh</button>
      <div id="status" class="muted small"></div>
      <div style="flex:1"></div>
      <button id="signout" title="Sign out of this browser">Sign out</button>
    </div>

    <!-- Firmware panel -->
    <div class="panel">
      <h3 style="margin-top:0;">Firmware</h3>
      <div class="kv">
        <div class="muted">Current device FW</div>
        <div><span id="fwCurrent" class="mono">—</span></div>

        <div class="muted">Manifest FW</div>
        <div><span id="fwManifest" class="mono">—</span></div>

        <div class="muted">Update available</div>
        <div><span id="fwUpdateFlag" class="pill">—</span></div>
      </div>
      <div class="row" style="margin-top:10px;">
        <button id="fwCheckBtn">Check (compare)</button>
        <button id="fwForceBtn" title="Copies a mosquitto command to force a manifest check">Force device to check now</button>
        <span id="fwMsg" class="muted small"></span>
      </div>
      <div id="fwCmdWrap" class="small mono" style="display:none; margin-top:8px;">
        <div class="muted">Copied to clipboard:</div>
        <div id="fwCmdText"></div>
      </div>
    </div>

    <div class="row">
      <div>Latest: <span id="latest" class="pill"></span></div>
      <div>Total rows: <strong id="count">0</strong></div>
      <div>Signal: <span id="signal" class="pill"></span></div>
      <div>Last connected: <span id="lastconn">—</span></div>
      <div>Last seen: <span id="lastseen">—</span></div>
      <div>Wi-Fi: <span id="rssiNow">—</span></div>
      <div>Latest Temp A: <span id="tempALatest">—</span></div>
      <div>Latest Temp B: <span id="tempBLatest">—</span></div>
    </div>

    <!-- Single combined chart -->
    <canvas id="chartTemps" height="200"></canvas>

    <table style="margin-top:16px;">
      <thead>
        <tr>
          <th>Time (UTC)</th>
          <th>Device</th>
          <th>Status</th>
          <th>Temp A °C</th>
          <th>Temp B °C</th>
          <th>RSSI</th>
          <th>FW</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <div class="panel" style="margin-top:16px;">
      <h3 style="margin-top:0;">Events</h3>
      <div id="events" class="mono small"></div>
      <div id="schema" class="mono small muted" style="margin-top:6px;"></div>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
  // --- CONFIG ---
  const SUPABASE_URL = "https://ojomcciunusemwszdnrl.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qb21jY2l1bnVzZW13c3pkbnJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3MTUyODYsImV4cCI6MjA3MDI5MTI4Nn0.U7gKI4QOklKkSq_Jbfxm6hQBrvS4JipV7z6KtIl1kz8";
  const MANIFEST_URL = "https://ojomcciunusemwszdnrl.supabase.co/storage/v1/object/public/ota/manifest.json";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const MQTT = {
    host: "3614c4f5a4b94a56a45e17893c67c2d7.s1.eu.hivemq.cloud",
    port: 8883,
    user: "aug25",
    pass: "f71pSt1cK",
    cafile: "C:\\\\certs\\\\cacert.pem",
    devId: "pump-1",
    topicCmd: (id) => `pump/uv/cmd/${id}`
  };

  // --- UI refs ---
  const els = Object.fromEntries([
    'auth','app','email','password','signin','authMsg','signout','range','refresh','status',
    'rows','latest','count','signal','lastconn','lastseen','rssiNow','tempALatest','tempBLatest',
    'fwCurrent','fwManifest','fwUpdateFlag','fwCheckBtn','fwForceBtn','fwMsg','fwCmdWrap','fwCmdText',
    'events','schema'
  ].map(id => [id, document.getElementById(id)]));

  function log(m){ els.events.textContent = `[${new Date().toLocaleTimeString()}] ${m}\n` + els.events.textContent; }

  // --- helpers ---
  function parseRaw(row){
    try{
      if (typeof row.raw === 'string') return JSON.parse(row.raw);
      if (row.raw && typeof row.raw === 'object') return row.raw;
    }catch(_){}
    return null;
  }

  function augmentRows(rows){
    return rows.map(r=>{
      const o = parseRaw(r) || {};
      const a = { ...r };
      a.$fw  = r.fw ?? o.fw ?? o.fw_version ?? null;
      a.$ta  = r.temp_pump_a_c ?? o.temp_pump_a_c ?? r.temp_a ?? o.temp_a ?? r.temp_c ?? o.temp_c ?? null;
      a.$tb  = r.temp_pump_b_c ?? o.temp_pump_b_c ?? r.temp_b ?? o.temp_b ?? null;
      a.$uv  = r.uv_status ?? o.uv_status ?? r.status ?? o.status ?? null;
      a.$rssi= r.rssi ?? o.rssi ?? r.wifi_rssi ?? o.wifi_rssi ?? null;
      a.$ts  = r.ts ?? r.inserted_at ?? o.ts ?? o.time ?? null;
      a.$dev = r.device_id ?? r.device ?? o.device_id ?? o.device ?? null;
      return a;
    });
  }

  function describeDetection(rows){
    if (!rows.length){ els.schema.textContent='No rows found.'; return; }
    const k = Object.keys(rows[0]).join(', ');
    const s = augmentRows([rows[0]])[0];
    els.schema.textContent =
      `Resolved → ts:${s.$ts?'✓':'—'}, fw:${s.$fw?'✓':'—'}, A:${s.$ta!=null?'✓':'—'}, B:${s.$tb!=null?'✓':'—'}, rssi:${s.$rssi!=null?'✓':'—'}, status:${s.$uv?'✓':'—'}, device:${s.$dev?'✓':'—'} | Raw keys: ${k}`;
  }

  function rssiLabel(dbm){ if (dbm>=-60) return 'Excellent'; if (dbm>=-67) return 'Very good'; if (dbm>=-75) return 'Good'; if (dbm>=-82) return 'Fair'; if (dbm>=-90) return 'Poor'; return 'Very poor'; }
  function isRecent(tsIso, sec){ if (!tsIso) return false; return (Date.now()-new Date(tsIso).getTime()) <= sec*1000; }

  function hoursFromRangeValue(v){
    if (v.endsWith('h')) return parseInt(v,10);
    const d = parseInt(v,10);
    return d * 24; // '7d','30d','90d'
  }

  // Choose a step that keeps ~1k-1.5k points total for performance & clarity
  function chooseStepMs(hours){
    if (hours <= 24) return 60*1000;           // 1 min → <= 1440 pts
    if (hours <= 24*7) return 10*60*1000;      // 10 min → <= 1008 pts
    if (hours <= 24*30) return 30*60*1000;     // 30 min → <= 1440 pts
    return 2*60*60*1000;                       // 2 h → <= 1080 pts for 90d
  }

  // Build a uniform time grid covering [startMs, endMs] inclusive
  function buildTimeGrid(startMs, endMs, stepMs){
    const grid = [];
    // snap start to step boundary for stable buckets
    const snappedStart = Math.floor(startMs / stepMs) * stepMs;
    for (let t = snappedStart; t <= endMs; t += stepMs) grid.push(t);
    return grid;
  }

  // Bin readings into the grid (exact bucket by floor index). Nulls remain for gaps.
  function binSeries(rows, gridStartMs, stepMs, bins){
    const A = new Array(bins).fill(null);
    const B = new Array(bins).fill(null);
    for (const r of rows){
      const ts = new Date(r.$ts).getTime();
      const idx = Math.floor((ts - gridStartMs) / stepMs);
      if (idx >= 0 && idx < bins){
        if (r.$ta != null) A[idx] = Number(r.$ta);
        if (r.$tb != null) B[idx] = Number(r.$tb);
      }
    }
    return { A, B };
  }

  // --- data load ---
  let tempsChart=null;

  async function fetchRows(fromIso){
    // Prefer ts filter
    try{
      const { data, error } = await sb.from('pump_readings')
        .select('*')
        .gte('ts', fromIso)
        .order('ts', { ascending:false })
        .limit(5000);
      if (!error && data && data.length) return { data, via:'ts' };
      if (error) log('Primary query (ts) error: ' + error.message);
    }catch(e){ log('Primary query (ts) threw: ' + e.message); }

    // Fallback inserted_at
    try{
      const { data, error } = await sb.from('pump_readings')
        .select('*')
        .gte('inserted_at', fromIso)
        .order('inserted_at', { ascending:false })
        .limit(5000);
      if (!error && data && data.length) return { data, via:'inserted_at' };
      if (error) log('Fallback query (inserted_at) error: ' + error.message);
    }catch(e){ log('Fallback query (inserted_at) threw: ' + e.message); }

    // Last resort: recent rows (no time filter)
    try{
      const { data, error } = await sb.from('pump_readings')
        .select('*')
        .order('ts', { ascending:false })
        .limit(500);
      if (!error && data) return { data, via:'no filter' };
      if (error) log('Last-resort query error: ' + error.message);
    }catch(e){ log('Last-resort query threw: ' + e.message); }

    return { data: [], via:'none' };
  }

  async function load(){
    const { data: { session } } = await sb.auth.getSession();
    if (!session){
      log('Not signed in.');
      els.status.textContent = 'Not signed in.';
      return;
    }

    const hours = hoursFromRangeValue(els.range.value);
    const stepMs = chooseStepMs(hours);
    const endMs = Date.now();
    const startMs = endMs - hours*3600*1000;
    const fromIso = new Date(startMs).toISOString();

    els.status.textContent = `Loading… (${els.range.options[els.range.selectedIndex].text})`;
    log(`Load start (from ${fromIso}) step=${Math.round(stepMs/60000)}m`);

    const { data: raw, via } = await fetchRows(fromIso);
    const rows
