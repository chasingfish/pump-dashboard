<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Pump Readings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --fg:#111; --muted:#666; --line:#e9e9e9; --bg:#fff; }
    body { font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; color:var(--fg); background:var(--bg); margin:20px; }
    h1 { margin:0 0 10px; font-size:20px; }
    .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:12px; }
    .panel { border:1px solid #eee; border-radius:10px; padding:12px; margin:14px 0; box-shadow:0 1px 2px rgba(0,0,0,0.04); }
    .kv { display:grid; grid-template-columns: 160px 1fr; gap:6px 10px; align-items:center; }
    .pill { padding:2px 8px; border-radius:12px; display:inline-block; border:1px solid var(--line); }
    .green { background:#e6f7ec; color:#156d2f; }
    .red   { background:#fde8e8; color:#9b1c1c; }
    .muted { color:var(--muted); }
    .small { font-size:12px; }
    .mono { font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace; }
    button, input, select { padding:8px 10px; border:1px solid var(--line); border-radius:8px; background:#fff; }
    button { cursor:pointer; }
    table { border-collapse: collapse; width:100%; }
    th, td { border:1px solid #ddd; padding:8px; }
    th { background:#f7f7f7; text-align:left; }
    #events { white-space:pre-wrap; max-height:160px; overflow:auto; border:1px solid #eee; border-radius:8px; padding:8px; background:#fafafa; }
    #schema { word-break: break-all; }
  </style>
</head>
<body>
  <div id="auth" style="margin-bottom:16px; display:none;">
    <h2>Sign in</h2>
    <div class="row">
      <input id="email" type="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Password" />
      <button id="signin">Sign in</button>
    </div>
    <div id="authMsg" style="color:#b00;"></div>
  </div>

  <div id="app" style="display:none;">
    <h1>Pump Readfings</h1>

    <div class="row">
      <label for="range">Time range:</label>
      <select id="range">
        <option value="12h">Last 12 hours</option>
        <option value="24h" selected>Last 24 hours</option>
        <option value="3d">Last 3 days</option>
        <option value="7d">Last 1 week</option>
        <option value="30d">Last 30 days</option>
        <option value="90d">Last 90 days</option>
      </select>
      <button id="refresh">Refresh</button>
      <div id="status" class="muted small"></div>
      <div style="flex:1"></div>
      <button id="signout" title="Sign out of this browser">Sign out</button>
    </div>

    <!-- Firmware panel -->
    <div class="panel">
      <h3 style="margin-top:0;">Firmware</h3>
      <div class="kv">
        <div class="muted">Current device FW</div>
        <div><span id="fwCurrent" class="mono">—</span></div>

        <div class="muted">Manifest FW</div>
        <div><span id="fwManifest" class="mono">—</span></div>

        <div class="muted">Update available</div>
        <div><span id="fwUpdateFlag" class="pill">—</span></div>
      </div>
      <div class="row" style="margin-top:10px;">
        <button id="fwCheckBtn">Check (compare)</button>
        <button id="fwForceBtn" title="Copies a mosquitto command to force a manifest check">Force device to check now</button>
        <span id="fwMsg" class="muted small"></span>
      </div>
      <div id="fwCmdWrap" class="small mono" style="display:none; margin-top:8px;">
        <div class="muted">Copied to clipboard:</div>
        <div id="fwCmdText"></div>
      </div>
    </div>

    <div class="row">
      <div>Latest: <span id="latest" class="pill"></span></div>
      <div>Total rows: <strong id="count">0</strong></div>
      <div>Signal: <span id="signal" class="pill"></span></div>
      <div>Last connected: <span id="lastconn">—</span></div>
      <div>Last seen: <span id="lastseen">—</span></div>
      <div>Wi-Fi: <span id="rssiNow">—</span></div>
      <div>Latest Temp A: <span id="tempALatest">—</span></div>
      <div>Latest Temp B: <span id="tempBLatest">—</span></div>
    </div>

    <!-- Chart -->
    <canvas id="chartTemps" height="180"></canvas>

    <table style="margin-top:16px;">
      <thead>
        <tr>
          <th>Time (UTC)</th>
          <th>Device</th>
          <th>Status</th>
          <th>Temp A °C</th>
          <th>Temp B °C</th>
          <th>RSSI</th>
          <th>FW</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <div class="panel" style="margin-top:16px;">
      <h3 style="margin-top:0;">Events</h3>
      <div id="events" class="mono small"></div>
      <div id="schema" class="mono small muted" style="margin-top:6px;"></div>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <script>
  // ===== error trap (avoid blank screen) =====
  window.onerror = function(msg, src, line, col){
    const box = document.getElementById('events');
    if (box) box.textContent = `[${new Date().toLocaleTimeString()}] ERROR: ${msg} @ ${src}:${line}:${col}\n` + box.textContent;
  };
  window.addEventListener('unhandledrejection', (e)=>{
    const box = document.getElementById('events');
    if (box) box.textContent = `[${new Date().toLocaleTimeString()}] PROMISE ERROR: ${e.reason}\n` + box.textContent;
  });

  // --- CONFIG ---
  const SUPABASE_URL = "https://ojomcciunusemwszdnrl.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qb21jY2l1bnVzZW13c3pkbnJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3MTUyODYsImV4cCI6MjA3MDI5MTI4Nn0.U7gKI4QOklKkSq_Jbfxm6hQBrvS4JipV7z6KtIl1kz8";
  const MANIFEST_URL = "https://ojomcciunusemwszdnrl.supabase.co/storage/v1/object/public/ota/manifest.json";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const MQTT = {
    host: "3614c4f5a4b94a56a45e17893c67c2d7.s1.eu.hivemq.cloud",
    port: 8883,
    user: "aug25",
    pass: "f71pSt1cK",
    cafile: "C:\\\\certs\\\\cacert.pem",
    devId: "pump-1",
    topicCmd: (id) => `pump/uv/cmd/${id}`
  };

  // --- UI refs ---
  const els = Object.fromEntries([
    'auth','app','email','password','signin','authMsg','signout','range','refresh','status',
    'rows','latest','count','signal','lastconn','lastseen','rssiNow','tempALatest','tempBLatest',
    'fwCurrent','fwManifest','fwUpdateFlag','fwCheckBtn','fwForceBtn','fwMsg','fwCmdWrap','fwCmdText',
    'events','schema'
  ].map(id => [id, document.getElementById(id)]));

  function log(m){ els.events.textContent = `[${new Date().toLocaleTimeString()}] ${m}\n` + els.events.textContent; }

  // --- helpers ---
  function parseRaw(row){
    try{
      if (typeof row.raw === 'string') return JSON.parse(row.raw);
      if (row.raw && typeof row.raw === 'object') return row.raw;
    }catch(_){}
    return null;
  }

  function augmentRows(rows){
    return rows.map(r=>{
      const o = parseRaw(r) || {};
      const a = { ...r };
      a.$fw  = r.fw ?? o.fw ?? o.fw_version ?? null;
      a.$ta  = r.temp_pump_a_c ?? o.temp_pump_a_c ?? r.temp_a ?? o.temp_a ?? r.temp_c ?? o.temp_c ?? null;
      a.$tb  = r.temp_pump_b_c ?? o.temp_pump_b_c ?? r.temp_b ?? o.temp_b ?? null;
      a.$uv  = r.uv_status ?? o.uv_status ?? r.status ?? o.status ?? null;
      a.$rssi= r.rssi ?? o.rssi ?? r.wifi_rssi ?? o.wifi_rssi ?? null;
      a.$ts  = r.ts ?? r.inserted_at ?? o.ts ?? o.time ?? null; // ISO8601
      a.$dev = r.device_id ?? r.device ?? o.device_id ?? o.device ?? null;
      return a;
    });
  }

  function describeDetection(rows){
    if (!rows.length){ els.schema.textContent='No rows found.'; return; }
    const k = Object.keys(rows[0]).join(', ');
    const s = augmentRows([rows[0]])[0];
    els.schema.textContent =
      `Resolved → ts:${s.$ts?'✓':'—'}, fw:${s.$fw?'✓':'—'}, A:${s.$ta!=null?'✓':'—'}, B:${s.$tb!=null?'✓':'—'}, rssi:${s.$rssi!=null?'✓':'—'}, status:${s.$uv?'✓':'—'}, device:${s.$dev?'✓':'—'} | Raw keys: ${k}`;
  }

  function rssiLabel(dbm){ if (dbm>=-60) return 'Excellent'; if (dbm>=-67) return 'Very good'; if (dbm>=-75) return 'Good'; if (dbm>=-82) return 'Fair'; if (dbm>=-90) return 'Poor'; return 'Very poor'; }

  function hoursFromRangeValue(v){
    if (v.endsWith('h')) return parseInt(v,10);
    const d = parseInt(v,10);
    return d * 24; // '3d','7d','30d','90d'
  }

  function chooseTimeUnit(hours){
    return (hours <= 48) ? 'hour' : 'day';
  }

  function computeWindow(){
    const hours = hoursFromRangeValue(els.range.value);
    const toMs = Date.now(); // now (client)
    const fromMs = toMs - hours * 3600 * 1000;
    return { fromMs, toMs, hours };
  }

  function dedupeByTsDev(rows){
    const map = new Map();
    for (const r of rows){
      const key = `${r.$ts}|${r.$dev||''}`;
      if (!map.has(key)) map.set(key, r);
    }
    return Array.from(map.values());
  }

  // ---------- DESCENDING pagination (now → past) to keep newest data ----------
  async function pageByFieldDesc(field, fromIso, toIso, pageSize=2000, hardCap=300000){
    let all = [];
    let cursor = toIso; // start at "now"
    while (all.length < hardCap){
      let q = sb.from('pump_readings')
        .select('*')
        .lte(field, cursor).gte(field, fromIso)
        .order(field, { ascending: false })
        .limit(pageSize);

      const { data, error } = await q;
      if (error) throw new Error(`${field} page error: ${error.message}`);

      const batch = data || [];
      if (!batch.length) break;

      all.push(...batch);               // newest → older
      const last = batch[batch.length - 1][field]; // oldest in this page
      if (!last || last <= fromIso) break;
      if (batch.length < pageSize) break;

      // next page strictly older than "last"
      cursor = last;
      // ensure strict "older than"
      // Supabase doesn't have "lt" chained after lte in the same call,
      // but we can adjust cursor slightly by string compare margin isn't reliable.
      // Simpler: rely on the next .lte(field, cursor) and server-side stable order; de-dupe later.
    }
    return all;
  }

  async function fetchWindowBothDesc(fromIso, toIso){
    let a = [], b = [], via = [];
    try { a = await pageByFieldDesc('ts', fromIso, toIso); via.push('ts'); } catch(e){ log(e.message); }
    try { b = await pageByFieldDesc('inserted_at', fromIso, toIso); via.push('inserted_at'); } catch(e){ log(e.message); }

    // Merge, de-dupe, filter strictly inside window, then ASC for chart
    const merged = dedupeByTsDev(augmentRows(a).concat(augmentRows(b))).filter(r=>r.$ts);
    const fromMs = new Date(fromIso).getTime();
    const toMs   = new Date(toIso).getTime();
    const inWin  = merged.filter(r => {
      const t = new Date(r.$ts).getTime();
      return Number.isFinite(t) && t >= fromMs && t <= toMs;
    });
    inWin.sort((x,y)=> new Date(x.$ts) - new Date(y.$ts)); // ascending
    return { rows: inWin, via: via.join('+') || 'none' };
  }

  // --- data load ---
  // ...existing code...
  let tempsChart = null;

  async function load(){
    const { data: { session } } = await sb.auth.getSession();
    if (!session){
      log('Not signed in.');
      els.status.textContent = 'Not signed in.';
      document.getElementById('auth').style.display = 'block';
      document.getElementById('app').style.display  = 'none';
      return;
    }

    const hours = hoursFromRangeValue(els.range.value);
    const toMs = Date.now(); // exact current time
    const fromMs = toMs - hours * 3600 * 1000;
    const fromIso = new Date(fromMs).toISOString();
    const toIso   = new Date(toMs).toISOString();
    const unit    = chooseTimeUnit(hours);

    els.status.textContent = `Loading… (${els.range.options[els.range.selectedIndex].text})`;
    log(`Load start: ${fromIso} → ${toIso}`);

    const { rows: rowsAllAsc, via } = await fetchWindowBothDesc(fromIso, toIso);

    // Table: latest 200, newest-first
    const rowsTable = rowsAllAsc.slice(-200).reverse();

    // Schema/debug
    describeDetection(rowsAllAsc.length ? [rowsAllAsc[0]] : []);
    els.count.textContent = rowsTable.length;

    // Latest badges
    if (rowsTable.length){
      const latest = rowsTable[0];
      els.latest.textContent = latest.$uv || '—';
      els.latest.className = 'pill ' + ((latest.$uv==='GREEN') ? 'green' : 'red');
      els.tempALatest.textContent = (latest.$ta==null)?'—':(+latest.$ta).toFixed(2)+' °C';
      els.tempBLatest.textContent = (latest.$tb==null)?'—':(+latest.$tb).toFixed(2)+' °C';
      els.fwCurrent.textContent = latest.$fw || '—';

      try{
        const did = latest.$dev;
        const { data: ds } = await sb.from('device_status')
          .select('last_seen_ts,last_online_ts,online').eq('device_id', did).single();
        if (ds){
          els.lastconn.textContent = ds.last_online_ts ? new Date(ds.last_online_ts).toLocaleString() : (ds.online?'now':'—');
          els.lastseen.textContent = ds.last_seen_ts ? new Date(ds.last_seen_ts).toLocaleString() : (ds.online?'now':'—');
          const fresh = rowsTable.filter(r => r.$rssi!=null && (Date.now()-new Date(r.$ts).getTime())<=120000).slice(0,5);
          if (fresh.length){
            const avg = fresh.reduce((s,r)=>s+Number(r.$rssi),0)/fresh.length;
            els.rssiNow.textContent = `${avg.toFixed(0)} dBm (${rssiLabel(avg)})`;
          } else els.rssiNow.textContent = 'No signal';
        }
      }catch(e){ log('device_status lookup failed: ' + e.message); }
    } else {
      els.latest.textContent = '—'; els.latest.className='pill';
      els.fwCurrent.textContent = '—'; els.rssiNow.textContent = '—';
    }

    // Table render
    els.rows.innerHTML = '';
    if (rowsTable.length){
      for (const r of rowsTable){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(r.$ts).toISOString()}</td>
          <td>${r.$dev ?? ''}</td>
          <td><span class="pill ${(r.$uv==='GREEN')?'green':'red'}">${r.$uv ?? ''}</span></td>
          <td>${r.$ta==null?'':Number(r.$ta).toFixed(2)}</td>
          <td>${r.$tb==null?'':Number(r.$tb).toFixed(2)}</td>
          <td>${r.$rssi ?? ''}</td>
          <td class="mono">${r.$fw ?? ''}</td>
        `;
        els.rows.appendChild(tr);
      }
    } else {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="7" style="text-align:center;color:#999;">No data for selected range.</td>`;
      els.rows.appendChild(tr);
    }

    // Chart
    try {
      renderTempsChart(rowsAllAsc, fromMs, toMs, unit);
    } catch(e) {
      log('Chart render failed: ' + e.message);
    }

    // Staleness
    if (rowsTable.length){
      const ageMin = Math.floor((Date.now() - new Date(rowsTable[0].$ts).getTime())/60000);
      const fresh = ageMin <= 10;
      els.signal.textContent = fresh ? 'OK' : `STALE: ${ageMin}m`;
      els.signal.className = 'pill ' + (fresh ? 'green' : 'red');
    } else {
      els.signal.textContent = 'NO DATA';
      els.signal.className = 'pill red';
    }

    els.status.textContent = `Last updated: ${new Date().toLocaleTimeString()} • via: ${via}`;
    log(`Load done: rows=${rowsAllAsc.length}, unit=${unit}`);
  }

  // --- chart (explicit [min,max] on both axes; decimation on) ---
  function computeYRange(datasets){
    const vals = [];
    for (const arr of datasets){
      for (const p of arr) if (p && Number.isFinite(p.y)) vals.push(p.y);
    }
    if (!vals.length) return null;
    const min = Math.min(...vals), max = Math.max(...vals);
    if (min === max) return { min: min - 1, max: max + 1 };
    const pad = (max - min) * 0.05;
    return { min: min - pad, max: max + pad };
  }

  // Removed duplicate declaration of tempsChart
  function renderTempsChart(allAsc, fromMs, toMs, unit) {
    // Filter out bad timestamps (e.g., 1970)
    const validRows = allAsc.filter(r => {
      const t = new Date(r.$ts).getTime();
      return t > 1609459200000 && t >= fromMs && t <= toMs; // Only after Jan 1, 2021
    });

    // Build hourly slots for <=48h, daily slots for longer
    const slotMs = (unit === 'hour') ? 3600 * 1000 : 24 * 3600 * 1000;
    const slots = [];
    for (let t = fromMs; t <= toMs; t += slotMs) {
      slots.push(t);
    }

    // For each slot, find the latest row in that slot
    function slotValue(rows, key) {
      return slots.map((start, i) => {
        const end = (i + 1 < slots.length) ? slots[i + 1] : toMs + slotMs;
        const inSlot = rows.filter(r => {
          const ts = new Date(r.$ts).getTime();
          return ts >= start && ts < end;
        });
        if (inSlot.length) {
          const latest = inSlot.reduce((a, b) => new Date(a.$ts) > new Date(b.$ts) ? a : b);
          return { x: start, y: Number(latest[key]) };
        } else {
          return { x: start, y: null };
        }
      });
    }

    const A = slotValue(validRows.filter(r => r.$ta != null), '$ta');
    const B = slotValue(validRows.filter(r => r.$tb != null), '$tb');

    const yr = computeYRange([A, B]) || { min: undefined, max: undefined };
    const ctx = document.getElementById('chartTemps').getContext('2d');
    const ds = [
      { data: A, label: 'Temp A (°C)', spanGaps: true, pointRadius: 0, borderWidth: 2, parsing: false },
      { data: B, label: 'Temp B (°C)', spanGaps: true, pointRadius: 0, borderWidth: 2, parsing: false }
    ];
    const opts = {
      parsing: false,
      animation: false,
      normalized: true,
      plugins: {
        legend: { display: true, position: 'top' },
        decimation: { enabled: true, algorithm: 'lttb', samples: 1000 }
      },
      scales: {
        x: {
          type: 'time',
          time: { unit },
          min: fromMs,
          max: toMs,
          ticks: { maxRotation: 0 }
        },
        y: {
          title: { display: true, text: '°C' },
          beginAtZero: false,
          min: yr.min,
          max: yr.max
        }
      }
    };
    const data = { datasets: ds };
    if (!tempsChart) {
      tempsChart = new Chart(ctx, { type: 'line', data, options: opts });
    } else {
      tempsChart.options.scales.x.min = fromMs;
      tempsChart.options.scales.x.max = toMs;
      tempsChart.options.scales.x.time.unit = unit;
      tempsChart.options.scales.y.min = yr.min;
      tempsChart.options.scales.y.max = yr.max;
      tempsChart.data.datasets[0].data = ds[0].data;
      tempsChart.data.datasets[1].data = ds[1].data;
      tempsChart.update('none');
    }
  }

  // --- firmware/commands (unchanged) ---
  function cmpSemver(a,b){ const pa=String(a).split('.').map(n=>parseInt(n,10)); const pb=String(b).split('.').map(n=>parseInt(n,10)); for(let i=0;i<3;i++){const x=pa[i]||0,y=pb[i]||0;if(x!==y)return x<y?-1:1;} return 0; }
  async function fetchManifest(){ const url = MANIFEST_URL + '?cb=' + Date.now(); const res = await fetch(url,{cache:'no-store'}); if(!res.ok) throw new Error('manifest fetch '+res.status); return res.json(); }
  async function refreshFirmwareCompare(){
    els.fwMsg.textContent='Fetching manifest…'; els.fwCmdWrap.style.display='none';
    try{
      const m = await fetchManifest();
      const mver = m.version || '—';
      els.fwManifest.textContent = mver;

      const cur = (els.fwCurrent.textContent||'').trim();
      if (!cur || cur==='—' || !mver || mver==='—'){
        els.fwUpdateFlag.textContent='—'; els.fwUpdateFlag.className='pill';
        els.fwMsg.textContent = cur && cur!=='—' ? 'Manifest loaded.' : 'Manifest loaded; waiting for device FW…';
        log('Manifest fetched, current FW ' + (cur && cur!=='—' ? cur : 'unknown') + '.');
        return;
      }
      const newer = cmpSemver(cur, mver) < 0;
      els.fwUpdateFlag.textContent = newer ? 'YES' : 'No';
      els.fwUpdateFlag.className = 'pill ' + (newer ? 'red' : 'green');
      els.fwMsg.textContent = newer ? 'New firmware available in manifest.' : 'Device is up to date.';
      log(`Manifest compare: current=${cur}, manifest=${mver}, update=${newer?'YES':'No'}`);
    }catch(e){
      els.fwManifest.textContent='—'; els.fwUpdateFlag.textContent='—'; els.fwUpdateFlag.className='pill';
      els.fwMsg.textContent='Manifest fetch failed.'; log('Manifest fetch failed: '+e.message);
    }
  }

  function buildForceCheckCommand(){
    const topic = MQTT.topicCmd(MQTT.devId);
    return `"C:\\Program Files\\mosquitto\\mosquitto_pub.exe" -h ${MQTT.host} -p ${MQTT.port} -V mqttv311 --cafile "${MQTT.cafile}" -u ${MQTT.user} -P ${MQTT.pass} -t "${topic}" -m "{\\"cmd\\":\\"check_update\\"}"`;
  }
  async function copyForceCheck(){
    const cmd = buildForceCheckCommand();
    try{ await navigator.clipboard.writeText(cmd); }catch(_){}
    els.fwCmdText.textContent = cmd;
    els.fwCmdWrap.style.display = 'block';
    els.fwMsg.textContent = 'Command copied. Paste into Command Prompt.';
    log('Force-check command copied.');
  }

  // --- auth & wiring ---
  async function refreshAuthUI(){
    const { data: { session } } = await sb.auth.getSession();
    const authed = !!session;
    document.getElementById('auth').style.display = authed ? 'none' : 'block';
    document.getElementById('app').style.display  = authed ? 'block' : 'none';
    if (authed){ await load(); await refreshFirmwareCompare(); }
  }

  document.getElementById('refresh').addEventListener('click', async ()=>{ await load(); await refreshFirmwareCompare(); });
  document.getElementById('range').addEventListener('change', async ()=>{ await load(); });
  document.getElementById('fwCheckBtn').addEventListener('click', refreshFirmwareCompare);
  document.getElementById('fwForceBtn').addEventListener('click', copyForceCheck);
  document.getElementById('signin').addEventListener('click', async ()=>{
    document.getElementById('authMsg').textContent = '';
    const { error } = await sb.auth.signInWithPassword({
      email: document.getElementById('email').value.trim(),
      password: document.getElementById('password').value
    });
    if (error){ document.getElementById('authMsg').textContent = error.message; return; }
    await refreshAuthUI();
  });
  document.getElementById('signout').addEventListener('click', async ()=>{ await sb.auth.signOut(); await refreshAuthUI(); });

  // start + periodic refresh (10s)
  refreshAuthUI();
  setInterval(async ()=>{
    const { data:{session} } = await sb.auth.getSession();
    if (session) { await load(); await refreshFirmwareCompare(); }
  }, 10000);
  </script>
</body>
</html>
